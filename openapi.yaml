openapi: 3.1.0
info:
    title: Comuting API
    description: |-
        This is the first draft of commuting API.
        以下除了 /login 外均需要在登入狀態下才能呼叫，若未登入會產生 401 錯誤。所有傳入錯誤參數的 request ，均會得到 400 錯誤。
    version: 1.0.0
tags:
    - name: user
      description: Operations about user
    - name: driver
      description: Operations for drivers
    - name: passenger
      description: Operations for passengers
paths:
    /login:
        post:
            tags: ["user"]
            summary: 登入系統
            description: 呼叫此 API 並傳入 E-mail 及密碼，即可登入。此 API 會回傳 Set-Cookies Header 來設定瀏覽器 Cookies 以維持登入狀態。
            operationId: login
            security: []
            requestBody:
                description: Supply user credential to login
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                email:
                                    type: string
                                    format: email
                                password:
                                    type: string
                                    format: password
            responses:
                "201":
                    description: Login successfully
                "400":
                    description: Invalid credential
                    $ref: "#/components/responses/ErrorMessage"
    /logout:
        post:
            tags: ["user"]
            security:
                - cookieAuth: []
            summary: 登出系統
            description: 此 API 會讓 Session 失效，並刪除瀏覽器中的 Session cookies 。
            operationId: logout
            responses:
                "201":
                    description: Successful operation

    /me:
        get:
            tags: ["user"]
            summary: 取得目前用戶資訊
            security:
                - cookieAuth: []
            operationId: user
            responses:
                "200":
                    description: successfully get current user
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/User"
    /routes:
        get:
            tags: ["passenger", "driver"]
            summary: 取得行程列表
            security:
                - cookieAuth: []
            description: |-
                不管是司機或乘客，所有取得行程的操作都是透過此 API 。 其 mode 參數需帶三種模式其中一種：
                 - available: 系統中現有有位置且允許搜尋的行程
                 - attending: 作為乘客參與的行程
                 - driving: 作為司機開車載人的行程
            operationId: passengerGetRoutes
            parameters:
                - in: query
                  name: mode
                  description: 模式選擇
                  schema:
                      type: string
                      enum: ["available", "attending", "driving"]
                - in: query
                  name: form
                  description: 起始日期時間
                  schema:
                      type: string
                      format: date-time
                      examples:
                          - "2023-10-22T08:30"
                          - "today"
                          - "now"
                - in: query
                  name: to
                  description: 結束日期時間
                  schema:
                      type: string
                      format: date
                      examples: ["2023-10-25"]
                - in: query
                  name: n
                  description: 回傳筆數
                  schema:
                      type: integer
                      examples: ["1"]
                - in: query
                  name: on
                  description: 上車站點
                  schema:
                      type: integer
                      examples: ["2"]
                - in: query
                  name: off
                  description: 下載站點
                  schema:
                      type: integer
                      examples: ["3"]
                - in: query
                  name: on-datetime
                  description: 上車時間。為相似度排序用，若未按相似度排序則無作用。
                  schema:
                      type: string
                      format: date-time
                      examples: ["2023-10-21T08:30"]
                - in: query
                  name: off-datetime
                  description: 下車時間。為相似度排序用，若未按相似度排序則無作用。
                  schema:
                      type: string
                      format: date-time
                      examples: ["2023-10-21T09:30"]
                - in: query
                  name: order-mode
                  description: 排序依據
                  schema:
                      type: string
                      enum: ["datetime", "similarity"]
            responses:
                "200":
                    description: 成功取得行程
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: "#/components/schemas/Route"
        post:
            tags: ["driver"]
            summary: 新增行程
            security:
                - cookieAuth: []
            requestBody:
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                date:
                                    type: string
                                    format: date
                                workStatus:
                                    type: boolean
                                    description: true 上班, false 下班
                                stations:
                                    type: array
                                    items:
                                        type: object
                                        properties:
                                            id:
                                                type: integer
                                                format: int64
                                                examples: [10]
                                            datetime:
                                                type: string
                                                format: date-time
                                                examples: ["2023-11-16T10:30"]
                                carInfo:
                                    $ref: "#/components/schemas/CarInfo"
            responses:
                "201":
                    description: Successful Operation
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Route"
    /routes/{id}:
        get:
            tags: ["passenger", "driver"]
            summary: 取得特定行程
            security:
                - cookieAuth: []
            parameters:
                - name: id
                  in: path
                  description: Route id
                  required: true
                  schema:
                      type: integer
                      format: int64
                      examples: [1]
            responses:
                "200":
                    description: Successfully get the specified route
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Route"
                "404":
                    description: Route not found
                    $ref: "#/components/responses/ErrorMessage"
        delete:
            tags: ["driver"]
            summary: 刪除特定行程
            security:
                - cookieAuth: []
            parameters:
                - name: id
                  in: path
                  description: Route id
                  required: true
                  schema:
                      type: integer
                      format: int64
                      examples: [1]
            responses:
                "204":
                    description: Successful operation
                "403":
                    description: Permission denied
                    $ref: "#/components/responses/ErrorMessage"
                "404":
                    description: Route not found
                    $ref: "#/components/responses/ErrorMessage"
    /routes/{id}/stations:
        get:
            tags: ["passenger", "driver"]
            summary: 取得行程內停靠站列表
            security:
                - cookieAuth: []
            parameters:
                - in: path
                  name: id
                  description: Route ID
                  required: true
                  schema:
                      type: string
            responses:
                "200":
                    description: Successful operation
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Route"
                "404":
                    description: Route not found
                    $ref: "#/components/responses/ErrorMessage"
    /routes/{id}/stations/{station_id}:
        put:
            tags: ["driver"]
            summary: 針對行程新增停靠站
            security:
                - cookieAuth: []
            parameters:
                - in: path
                  name: id
                  description: Route ID
                  required: true
                  schema:
                      type: integer
                      format: int64
                      examples: [10]
                - in: path
                  name: station_id
                  description: Station ID
                  required: true
                  schema:
                      type: integer
                      format: int64
                      examples: [20]
            requestBody:
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                datetime:
                                    type: string
                                    format: date-time
                                    examples: ["2023-10-22T10:30"]
            responses:
                "204":
                    description: Operation Successful
                "403":
                    description: Permission Denied
                    $ref: "#/components/responses/ErrorMessage"
        delete:
            tags: ["driver"]
            summary: 針對行程刪除停靠站
            security:
                - cookieAuth: []
            responses:
                "204":
                    description: Successful operation
                "403":
                    description: Permission Denied
                    $ref: "#/components/responses/ErrorMessage"
    /requests:
        get:
            tags: ["passenger", "driver"]
            summary: 取得請求列表
            security:
                - cookieAuth: []
            operationId: requestsGet
            parameters:
                - name: mode
                  in: query
                  schema:
                      type: string
                      enum: ["available", "me"]
            responses:
                "200":
                    description: 成功取得請求
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: "#/components/schemas/Request"
        post:
            tags: ["passenger", "driver"]
            summary: 新增請求
            security:
                - cookieAuth: []
            requestBody:
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                date:
                                    type: string
                                    format: date
                                    examples: ["2023-10-22"]
                                workStatus:
                                    type: boolean
                                route_id:
                                    type: integer
                                    format: int64
                                    examples: [10]
                                on_station_id:
                                    type: integer
                                    format: int64
                                    examples: [20]
                                off_station_id:
                                    type: integer
                                    format: int64
                                    examples: [20]
            responses:
                "200":
                    description: Request created
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Request"
                "400":
                    description: 有相同時間的請求，或該時間已安排行程
                    $ref: "#/components/responses/ErrorMessage"
    /requests/{id}:
        get:
            tags: ["passenger", "driver"]
            summary: 取得特定請求
            security:
                - cookieAuth: []
            parameters:
                - in: path
                  name: id
                  required: true
                  description: "請求 ID"
                  schema:
                      type: integer
                      format: int64
                      examples: ["3"]
            responses:
                "200":
                    description: 操作成功
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Request"
        delete:
            tags: ["passenger", "driver"]
            summary: 刪除特定請求
            security:
                - cookieAuth: []
            responses:
                "204":
                    description: 操作成功
                "403":
                    description: 沒有權限刪除此請求
                    $ref: "#/components/responses/ErrorMessage"
    /requests/{id}/accept:
        post:
            tags: ["driver"]
            summary: 接受共乘請求
            security:
                - cookieAuth: []
            responses:
                "204":
                    description: 成功接受請求
                "403":
                    description: 沒有權限接受此請求
                    $ref: "#/components/responses/ErrorMessage"
    /requests/{id}/deny:
        post:
            tags: ["driver"]
            summary: 拒絕共乘請求
            security:
                - cookieAuth: []
            responses:
                "204":
                    description: 成功拒絕請求
                "403":
                    description: 沒有權限拒絕此請求
                    $ref: "#/components/responses/ErrorMessage"
    /notifications:
        get:
            tags: ["passenger", "driver"]
            summary: 取得通知列表
            security:
                - cookieAuth: []
            parameters:
                - in: query
                  name: mode
                  description: 通知取得模式
                  schema:
                      type: string
                      enum: ["all", "passenger", "driver"]
            responses:
                "200":
                    description: 成功取得通知
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: "#/components/schemas/Notification"
    /notifications/read:
        post:
            tags: ["passenger", "driver"]
            summary: 通知列表設為已讀
            security:
                - cookieAuth: []
            parameters:
                - in: query
                  name: mode
                  description: 可以選擇只設定乘客或司機通知列表為已讀
                  schema:
                      type: string
                      enum: ["passenger", "driver"]
            responses:
                "204":
                    description: 成功把通知列表設為已讀
    /notifications/{id}:
        get:
            tags: ["passenger", "driver"]
            summary: 使用通知 ID 取得通知
            security:
                - cookieAuth: []
            parameters:
                - in: path
                  name: id
                  required: true
                  schema:
                      type: integer
                      format: int64
                      examples: [40]
            responses:
                "200":
                    description: 成功取得通知
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Notification"
                "404":
                    description: 找不到此則通知
                    $ref: "#/components/responses/ErrorMessage"
    /notifications/{id}/read:
        post:
            tags: ["passenger", "driver"]
            summary: 設定通知為已讀
            security:
                - cookieAuth: []
            responses:
                "204":
                    description: 操作成功
                "404":
                    description: 找不到此則通知
                    $ref: "#/components/responses/ErrorMessage"
    /stations:
        get:
            tags: ["passenger", "driver"]
            summary: 取得所有站點
            security:
                - cookieAuth: []
            responses:
                "200":
                    description: 取得站點成功
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: '#/components/schemas/Station'
    /stations/{id}:
        get:
            tags: ["passenger", "driver"]
            security:
                - cookieAuth: []
            parameters:
                - in: path
                  name: id
                  description: 站點 ID
                  required: true
                  schema:
                      type: integer
                      format: int64
                      examples: ["3"]
            responses:
                "200":
                    description: 取得站點成功
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Station'
components:
    schemas:
        User:
            type: object
            properties:
                id:
                    type: integer
                    format: int64
                    examples: [10]
                name:
                    type: string
                    examples: [John James]
                avatar:
                    type: string
                    format: url
                email:
                    type: string
                    examples: [john@email.com]
                password:
                    type: string
                    writeOnly: true
                    examples: ["<password>"]
                
        CarInfo:
            type: object
            properties:
                color:
                    type: string
                    format: string
                    examples: ["紅色"]
                capacity:
                    type: integer
                    description: 最大共乘人數
                    examples: ["3"]
                licensePlateNumber:
                    type: string
                    description: 車牌號碼
                    examples: ["ABC-0123"]
        Route:
            type: object
            properties:
                id:
                    type: integer
                    format: int64
                    examples: [23]
                date:
                    type: string
                    format: date
                    examples: ["2023-10-22"]
                workStatus:
                    type: boolean
                status:
                    type: string
                    readOnly: true
                    enum: ["available", "full", "expired", "deleted"]
                stations:
                    type: array
                    items:
                        type: object
                        properties:
                            id:
                                type: integer
                                description: station ID
                                examples: [5]
                            name:
                                type: string
                                format: string
                                examples: ["臺大校門口"]
                            datetime:
                                type: string
                                format: datetime
                                examples: ["2023-10-22T07:30"]
                driver:
                    $ref: "#/components/schemas/User"
        Request:
            type: object
            properties:
                id:
                    type: integer
                    format: int64
                    examples: ["20"]
                status:
                    type: string
                    readOnly: true
                    enum: ["new", "accepted", "denied", "expired", "deleted"]
                    examples: ["new"]
                passenger:
                    $ref: "#/components/schemas/User"
                route:
                    $ref: "#/components/schemas/Route"
                on:
                    $ref: "#/components/schemas/Station"
                off:
                    $ref: "#/components/schemas/Station"
        Station:
            type: object
            properties:
                id:
                    type: integer
                    format: int64
                    examples: ["23"]
                name:
                    type: string
                    format: string
                    examples: ["臺大校門口"]
        Notification:
            type: object
            properties:
                id:
                    type: integer
                    format: int64
                    examples: [3]
                read:
                    type: boolean
                # TODO
    responses:
        ErrorMessage:
            description: 回傳錯誤訊息用
            content:
                application/json:
                    schema:
                        type: object
                        properties:
                            message:
                                type: string
                                description: Error message
    securitySchemes:
        cookieAuth:
            type: apiKey
            name: SESSION_ID
            in: cookie
